<!DOCTYPE html>
<html>
<head>
<title>test</title>
<script src="http://cdn.sockjs.org/sockjs-0.1.min.js"></script>
<script type="text/javascript" src="https://raw.github.com/atomizejs/cereal/master/lib/cereal.js"></script>
<script type="text/javascript" src="https://raw.github.com/atomizejs/atomize-client/master/lib/atomize.js"></script>
<script type="text/javascript" src="queue.js"></script>
<script>
var writer;
var next = 0;
var value;

var atomize = new Atomize("http://localhost:9999/atomize");

function write() {
    enqueue(next, function (e) { next += 1; loop(); });
}

function read() {
    dequeue(function (result) {
        value = result;
        loop();
    });
}

function loop() {
    if (writer) {
        setTimeout("write();", 1);
    } else {
        setTimeout("read();", 1);
    }
}

function log() {
    if (writer) {
        console.log("Writing: " + next);
    } else {
        console.log("Dequeued: " + value);
    }
    debug();
}

function debug() {
    setTimeout("log();", 1000);
}

function start() {
    atomize.atomically(function () {
        if (undefined === atomize.root.queueWriter) {
            atomize.root.queueWriter = "taken";
            return true;
        } else {
            return false;
        }
    }, function (w) {
        writer = w;
        loop();
        debug();
    });
}
</script>
</head>
<body onload="start();">
</body>
</html>
